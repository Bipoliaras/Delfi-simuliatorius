package simulator;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Mockito.when;

import com.fasterxml.jackson.databind.ObjectMapper;
import java.util.List;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.Mockito;
import org.springframework.web.client.RestTemplate;
import simulator.Constants.CommentTypes;
import simulator.comments.CommentEndpoint;
import simulator.domain.entity.Comment;


class CommentEndpointTests {

  private String response = "{\"data\":{\"getCommentsByArticleId\":{\"article_id\":87270563,\"count_total\":157,\"count_total_main_posts\":114,\"count_registered\":33,\"count_registered_main_posts\":18,\"count_anonymous_main_posts\":96,\"count_anonymous\":124,\"comments\":[{\"id\":268698824,\"subject\":\"nu\",\"content\":\"... ale visai kai kuriems patinka...\\n... turėti vos ne kieme... šiaurės korėją 2...&#x1F601&#x1F601&#x1F601\\n... očevydno no nevetojatno... \",\"created_time\":\"2021-05-24T08:07:59.000Z\",\"created_time_unix\":1621843679,\"article_entity\":{\"article_id\":87270563,\"count_total\":157,\"count_anonymous\":124,\"__typename\":\"ArticleEntity\"},\"vote\":null,\"author\":null,\"parent_comment\":null,\"quote_to_comment\":null,\"reaction\":[],\"count_replies\":0,\"count_registered_replies\":0,\"status\":\"ACTIVE\",\"__typename\":\"Comment\",\"replies\":null},{\"id\":268698776,\"subject\":\"Ru\",\"content\":\"Kaip baisu. Ir kodel tokie kaip sis sukelia gresme kitu saliu pilieciams. Gerai, kad ji sueme. Nes kitur skrisdamas sukeltu gresme dar kitiema zmonems. Prasidejo tautos isdaviku valymas. \",\"created_time\":\"2021-05-24T08:07:23.000Z\",\"created_time_unix\":1621843643,\"article_entity\":{\"article_id\":87270563,\"count_total\":157,\"count_anonymous\":124,\"__typename\":\"ArticleEntity\"},\"vote\":null,\"author\":null,\"parent_comment\":null,\"quote_to_comment\":null,\"reaction\":[],\"count_replies\":0,\"count_registered_replies\":0,\"status\":\"ACTIVE\",\"__typename\":\"Comment\",\"replies\":null},{\"id\":268698712,\"subject\":\"rezimas i veidrodi neziuri\",\"content\":\"a garlavos yvikiai ir sistemiskas dalyviu persekiojimas arba Venskienes ekstradicija, interneto svetainiu ir televizijos blokavimas parodo kokia zodzio laisve yra geroves valstybeje...\",\"created_time\":\"2021-05-24T08:06:46.000Z\",\"created_time_unix\":1621843606,\"article_entity\":{\"article_id\":87270563,\"count_total\":157,\"count_anonymous\":124,\"__typename\":\"ArticleEntity\"},\"vote\":null,\"author\":null,\"parent_comment\":null,\"quote_to_comment\":null,\"reaction\":[{\"comment_id\":268698712,\"name\":\"Like\",\"reaction\":\"like\",\"count\":1,\"__typename\":\"Reaction\"}],\"count_replies\":0,\"count_registered_replies\":0,\"status\":\"ACTIVE\",\"__typename\":\"Comment\",\"replies\":null},{\"id\":268698692,\"subject\":\"Pagaliau\",\"content\":\"Butai PIGS!\",\"created_time\":\"2021-05-24T08:06:41.000Z\",\"created_time_unix\":1621843601,\"article_entity\":{\"article_id\":87270563,\"count_total\":157,\"count_anonymous\":124,\"__typename\":\"ArticleEntity\"},\"vote\":null,\"author\":null,\"parent_comment\":null,\"quote_to_comment\":null,\"reaction\":[{\"comment_id\":268698692,\"name\":\"Ha-Ha\",\"reaction\":\"haha\",\"count\":1,\"__typename\":\"Reaction\"}],\"count_replies\":0,\"count_registered_replies\":0,\"status\":\"ACTIVE\",\"__typename\":\"Comment\",\"replies\":null},{\"id\":268698644,\"subject\":\"O šiaip\",\"content\":\"Jeigu Autobusu iš Vilniaus į Klaipėdą važiuotų Kaune ieškomas recidyvistas ir ties Kaunu būtų reidas, išlaipintų visus keleivius ir apieškotų autobusą. Galų gale policija suimtų recidyvistą. ar čia ir būtų skandalas, nes kitiems autobuso keleiviams tai sugadinta kelionė?\",\"created_time\":\"2021-05-24T08:06:23.000Z\",\"created_time_unix\":1621843583,\"article_entity\":{\"article_id\":87270563,\"count_total\":157,\"count_anonymous\":124,\"__typename\":\"ArticleEntity\"},\"vote\":null,\"author\":null,\"parent_comment\":null,\"quote_to_comment\":null,\"reaction\":[],\"count_replies\":0,\"count_registered_replies\":0,\"status\":\"ACTIVE\",\"__typename\":\"Comment\",\"replies\":null},{\"id\":268698540,\"subject\":\"va kur nafalnas pagaliau atnes nauda, o tai sedi dykaduonis ant pencininku galvu\",\"content\":\"Министр юстиции России Константин Чуйченко оценил предложение главы ФСИН по поводу более активного использования труда заключённых, что позволит в определённой мере заменить ими трудовых мигрантов.\\n\\nЧуйченко считает такую идею правильной.\\n\\nНапомним, ранее директор ФСИН России Александр Калашников выступил с предложением о более активном использовании труда заключённых вместо трудовых мигрантов-иностранцев, что привело бы к решению многих проблем, которые связаны с дефицитом рабочей силы в некоторых российских регионах.\\n\",\"created_time\":\"2021-05-24T08:05:35.000Z\",\"created_time_unix\":1621843535,\"article_entity\":{\"article_id\":87270563,\"count_total\":157,\"count_anonymous\":124,\"__typename\":\"ArticleEntity\"},\"vote\":null,\"author\":null,\"parent_comment\":null,\"quote_to_comment\":null,\"reaction\":[],\"count_replies\":0,\"count_registered_replies\":0,\"status\":\"ACTIVE\",\"__typename\":\"Comment\",\"replies\":null},{\"id\":268698536,\"subject\":\"pendosai ir eurosai\",\"content\":\"prashiko eilini savo agenta zhopoliza\",\"created_time\":\"2021-05-24T08:05:35.000Z\",\"created_time_unix\":1621843535,\"article_entity\":{\"article_id\":87270563,\"count_total\":157,\"count_anonymous\":124,\"__typename\":\"ArticleEntity\"},\"vote\":null,\"author\":null,\"parent_comment\":null,\"quote_to_comment\":null,\"reaction\":[],\"count_replies\":0,\"count_registered_replies\":0,\"status\":\"ACTIVE\",\"__typename\":\"Comment\",\"replies\":null},{\"id\":268698496,\"subject\":\"Briuselio pirdžiai\",\"content\":\"Gilus susirūpinimas ir viskas tuom pasibaigs\",\"created_time\":\"2021-05-24T08:05:14.000Z\",\"created_time_unix\":1621843514,\"article_entity\":{\"article_id\":87270563,\"count_total\":157,\"count_anonymous\":124,\"__typename\":\"ArticleEntity\"},\"vote\":null,\"author\":null,\"parent_comment\":null,\"quote_to_comment\":null,\"reaction\":[{\"comment_id\":268698496,\"name\":\"Ha-Ha\",\"reaction\":\"haha\",\"count\":1,\"__typename\":\"Reaction\"}],\"count_replies\":0,\"count_registered_replies\":0,\"status\":\"ACTIVE\",\"__typename\":\"Comment\",\"replies\":null},{\"id\":268698456,\"subject\":\"nuomonė\",\"content\":\"reikėjo pilotams nepaklusti naikintuvo reikalavimams , ne manau kad būtu išdrise numušt keleivinį lėktuvą.\",\"created_time\":\"2021-05-24T08:04:53.000Z\",\"created_time_unix\":1621843493,\"article_entity\":{\"article_id\":87270563,\"count_total\":157,\"count_anonymous\":124,\"__typename\":\"ArticleEntity\"},\"vote\":null,\"author\":null,\"parent_comment\":null,\"quote_to_comment\":null,\"reaction\":[],\"count_replies\":0,\"count_registered_replies\":0,\"status\":\"ACTIVE\",\"__typename\":\"Comment\",\"replies\":null},{\"id\":268698452,\"subject\":\"Norėčiau klysti\",\"content\":\"Tačiau kol kerzavas batas neišspardys užpakalio vaivorykštiniam, nieko nebus.\",\"created_time\":\"2021-05-24T08:04:50.000Z\",\"created_time_unix\":1621843490,\"article_entity\":{\"article_id\":87270563,\"count_total\":157,\"count_anonymous\":124,\"__typename\":\"ArticleEntity\"},\"vote\":null,\"author\":null,\"parent_comment\":null,\"quote_to_comment\":null,\"reaction\":[],\"count_replies\":0,\"count_registered_replies\":0,\"status\":\"ACTIVE\",\"__typename\":\"Comment\",\"replies\":null},{\"id\":268698444,\"subject\":\"Pikta\",\"content\":\"Kad dėl tarakono užgaidų turėjo kitų šalių piliečiai vietoj 3 val parsirasti po 12 val namo ir dar 3 val būti tardomi bulbašų omono. Jei b..y..bia..rankis nesugeba susitvarkyti su savo opozicija pats, tai kokio galo reikia įtraukinėti kitos šalies piliečius. Už šitą turėtų rimtą ragą lukšui įstatyti eu. Kad europoje neliktų jokio lukšenkos chebros ir jo pačio, nei turtų, nei vaikų. Eu piliečiai patys turėtų pradėti aiškintis ar jų kaimynas kokim Krušavėlį ne omoninikas ar kgbistas ir ar atžalos jų nelanko kokio oksfordo. Pašolvonint visus nuo europos gero.\",\"created_time\":\"2021-05-24T08:04:46.000Z\",\"created_time_unix\":1621843486,\"article_entity\":{\"article_id\":87270563,\"count_total\":157,\"count_anonymous\":124,\"__typename\":\"ArticleEntity\"},\"vote\":null,\"author\":null,\"parent_comment\":null,\"quote_to_comment\":null,\"reaction\":[],\"count_replies\":0,\"count_registered_replies\":0,\"status\":\"ACTIVE\",\"__typename\":\"Comment\",\"replies\":null},{\"id\":268698440,\"subject\":\"o reikia vardo?\",\"content\":\"O kai amerikonų smogikai žudo svetimose valstybėse savo nedraugus- viskas ko? Irakas, Iranas, Sirija, Afganistanas, Gvantanamas, Nemenčinės kalėjimas, ...... O Bolivijos prezidento lėktuvo nusodinimas, Panamos okupacija? ir t.t. ir t.t.\",\"created_time\":\"2021-05-24T08:04:42.000Z\",\"created_time_unix\":1621843482,\"article_entity\":{\"article_id\":87270563,\"count_total\":157,\"count_anonymous\":124,\"__typename\":\"ArticleEntity\"},\"vote\":null,\"author\":null,\"parent_comment\":null,\"quote_to_comment\":null,\"reaction\":[{\"comment_id\":268698440,\"name\":\"Like\",\"reaction\":\"like\",\"count\":1,\"__typename\":\"Reaction\"},{\"comment_id\":268698440,\"name\":\"Dislike\",\"reaction\":\"dislike\",\"count\":1,\"__typename\":\"Reaction\"}],\"count_replies\":0,\"count_registered_replies\":0,\"status\":\"ACTIVE\",\"__typename\":\"Comment\",\"replies\":null},{\"id\":268698372,\"subject\":\"UFFO\",\"content\":\"sneka visokie lopatologai jus teisininku paklauskit ar toks veiksmas isvis teisetas ir ar yra islygos jog taip buvo galima pasielgti kai noras didelis ir yra galimybiu??\",\"created_time\":\"2021-05-24T08:04:04.000Z\",\"created_time_unix\":1621843444,\"article_entity\":{\"article_id\":87270563,\"count_total\":157,\"count_anonymous\":124,\"__typename\":\"ArticleEntity\"},\"vote\":null,\"author\":null,\"parent_comment\":null,\"quote_to_comment\":null,\"reaction\":[],\"count_replies\":0,\"count_registered_replies\":0,\"status\":\"ACTIVE\",\"__typename\":\"Comment\",\"replies\":null},{\"id\":268698352,\"subject\":\"gal\",\"content\":\"galėtų skrydyje buv\",\"created_time\":\"2021-05-24T08:04:00.000Z\",\"created_time_unix\":1621843440,\"article_entity\":{\"article_id\":87270563,\"count_total\":157,\"count_anonymous\":124,\"__typename\":\"ArticleEntity\"},\"vote\":null,\"author\":null,\"parent_comment\":null,\"quote_to_comment\":null,\"reaction\":[],\"count_replies\":0,\"count_registered_replies\":0,\"status\":\"ACTIVE\",\"__typename\":\"Comment\",\"replies\":null},{\"id\":268698348,\"subject\":\"Čia ne užgrobimas o \",\"content\":\"Nusikaltelio sulaikymas \",\"created_time\":\"2021-05-24T08:03:57.000Z\",\"created_time_unix\":1621843437,\"article_entity\":{\"article_id\":87270563,\"count_total\":157,\"count_anonymous\":124,\"__typename\":\"ArticleEntity\"},\"vote\":null,\"author\":null,\"parent_comment\":null,\"quote_to_comment\":null,\"reaction\":[{\"comment_id\":268698348,\"name\":\"Like\",\"reaction\":\"like\",\"count\":1,\"__typename\":\"Reaction\"}],\"count_replies\":0,\"count_registered_replies\":0,\"status\":\"ACTIVE\",\"__typename\":\"Comment\",\"replies\":null},{\"id\":268698324,\"subject\":\"Fix\",\"content\":\"Kažkas cia netaip. Vykdyti tokia sudėtinga ir pavojinga operacija dėl vieno žmogaus? Juk KGB ji tyliai ir ramiai galėjo pašalinti.\",\"created_time\":\"2021-05-24T08:03:43.000Z\",\"created_time_unix\":1621843423,\"article_entity\":{\"article_id\":87270563,\"count_total\":157,\"count_anonymous\":124,\"__typename\":\"ArticleEntity\"},\"vote\":null,\"author\":null,\"parent_comment\":null,\"quote_to_comment\":null,\"reaction\":[],\"count_replies\":1,\"count_registered_replies\":0,\"status\":\"ACTIVE\",\"__typename\":\"Comment\",\"replies\":[{\"id\":268698652,\"subject\":\"Arvis\",\"content\":\"kgb ne VSD viskas rimta\",\"created_time\":\"2021-05-24T08:06:30.000Z\",\"created_time_unix\":1621843590,\"article_entity\":{\"article_id\":87270563,\"count_total\":157,\"count_anonymous\":124,\"__typename\":\"ArticleEntity\"},\"vote\":null,\"author\":null,\"parent_comment\":{\"id\":268698324,\"subject\":\"Fix\",\"__typename\":\"Comment\"},\"quote_to_comment\":null,\"reaction\":[],\"count_replies\":0,\"count_registered_replies\":0,\"status\":\"ACTIVE\",\"__typename\":\"Comment\"}]},{\"id\":268698320,\"subject\":\"Domertas\",\"content\":\"Net šlykštu klausytis kaip dirba Lietuvos propagandistai. 1. 2013 m. USA pareigūnai tūpdė net Bolivijos prezidento lėktuvą Austrijoje, ieškojo Snoudeno (Washington Post). 2. Lukašenka areštavo vieną iš perversmo organizatorių, neabejotinai Lietuvos VSD agentą ir šalies išdaviką, nusikaltėlį. 3. Areštavo savo šalies teritorijoje pagal visus tarptautinius ir Baltarusijos įstatymus. 4. Lietuva palaiko glaudžius prekybos ryšius su Baltarusija, daug politikų, tame tarpe ir konservatorių turi su Baltarusiją verslo reikalų. Todėl Lukašenkai nieko nebus. O kalčiausias dėl VSD agento arešto yra žioplas VSD direktorius Jauniškis (buvęs Landsbergio apsauginis).\",\"created_time\":\"2021-05-24T08:03:43.000Z\",\"created_time_unix\":1621843423,\"article_entity\":{\"article_id\":87270563,\"count_total\":157,\"count_anonymous\":124,\"__typename\":\"ArticleEntity\"},\"vote\":null,\"author\":null,\"parent_comment\":null,\"quote_to_comment\":null,\"reaction\":[{\"comment_id\":268698320,\"name\":\"Like\",\"reaction\":\"like\",\"count\":3,\"__typename\":\"Reaction\"}],\"count_replies\":0,\"count_registered_replies\":0,\"status\":\"ACTIVE\",\"__typename\":\"Comment\",\"replies\":null},{\"id\":268698268,\"subject\":\"Gera specialybe\",\"content\":\"Rytų Europos studijų centro (RESC) vadovo teigimu,.Pliurpalogijos direktorius.\",\"created_time\":\"2021-05-24T08:03:23.000Z\",\"created_time_unix\":1621843403,\"article_entity\":{\"article_id\":87270563,\"count_total\":157,\"count_anonymous\":124,\"__typename\":\"ArticleEntity\"},\"vote\":null,\"author\":null,\"parent_comment\":null,\"quote_to_comment\":null,\"reaction\":[],\"count_replies\":0,\"count_registered_replies\":0,\"status\":\"ACTIVE\",\"__typename\":\"Comment\",\"replies\":null},{\"id\":268698260,\"subject\":\"?\",\"content\":\"Dabar Lukašenkos vietoje Pratasevičių apklausčiau, apklausos įrašą paviešinčiau ir pasiūlyčiau iškeisti į Lietuvoje kalintį Paleckį.\",\"created_time\":\"2021-05-24T08:03:20.000Z\",\"created_time_unix\":1621843400,\"article_entity\":{\"article_id\":87270563,\"count_total\":157,\"count_anonymous\":124,\"__typename\":\"ArticleEntity\"},\"vote\":null,\"author\":null,\"parent_comment\":null,\"quote_to_comment\":null,\"reaction\":[],\"count_replies\":0,\"count_registered_replies\":0,\"status\":\"ACTIVE\",\"__typename\":\"Comment\",\"replies\":null},{\"id\":268698220,\"subject\":\"X\",\"content\":\"Jaunuolis neturejes galimybiu paso buvo sulaikytas...\",\"created_time\":\"2021-05-24T08:02:58.000Z\",\"created_time_unix\":1621843378,\"article_entity\":{\"article_id\":87270563,\"count_total\":157,\"count_anonymous\":124,\"__typename\":\"ArticleEntity\"},\"vote\":null,\"author\":null,\"parent_comment\":null,\"quote_to_comment\":null,\"reaction\":[],\"count_replies\":0,\"count_registered_replies\":0,\"status\":\"ACTIVE\",\"__typename\":\"Comment\",\"replies\":null}],\"__typename\":\"ArticleEntity\"}}}\n";


  private RestTemplate restTemplate;

  @BeforeEach
  void setup() {
    restTemplate = Mockito.mock(RestTemplate.class);
  }

  @Test
  void givenCommentResponse_whenGetComments_returnsComments() {

      when(restTemplate.postForObject(Mockito.anyString(),Mockito.any(Object.class) , Mockito.any()))
          .thenReturn(response);

      CommentEndpoint commentEndpoint = new CommentEndpoint(restTemplate, new ObjectMapper());

      List<Comment> commentList = commentEndpoint.getComments(87270563L, CommentTypes.ANONYMOUS_MAIN);

      assertThat(commentList)
          .isNotEmpty()
          .isNotNull()
          .hasSize(20);

  }

  @Test
  void givenError_whenGetComments_returnEmptyList() {
    when(restTemplate.postForObject(Mockito.any(), Mockito.any(), Mockito.any()))
        .thenThrow(new RuntimeException());

    CommentEndpoint commentEndpoint = new CommentEndpoint(restTemplate, new ObjectMapper());

    List<Comment> commentList = commentEndpoint.getComments(87270563L, CommentTypes.ANONYMOUS_MAIN);

    assertThat(commentList)
        .isEmpty();
  }

}
